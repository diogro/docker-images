# Copyright (c) by Diogo Melo
# Distributed under the terms of the MIT License.

FROM krallin/ubuntu-tini:trusty

MAINTAINER Diogo Melo <diogro@gmail.com>

# Basic stuff
RUN apt-get update && apt-get install -yq --no-install-recommends \
    wget \
    bzip2 \
    ca-certificates \
    sudo \
    locales \
    git \
    zsh \
    vim \
	curl \
    && apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# R dependencies
RUN apt-get update && apt-get install -yq --no-install-recommends \
    libcairo2 libgfortran3 libglib2.0-0 libjpeg8 libpango-1.0-0 libpangocairo-1.0-0 \
    libtcl8.6 libtiff5 libtk8.6 libx11-6 libxt6 \
    && apt-get clean && \
    rm -rf /var/lib/apt/lists/*

RUN wget https://mran.revolutionanalytics.com/install/mro/3.2.5/MRO-3.2.5-Ubuntu-14.4.x86_64.deb && \
    echo "f73378c5942621f8f49f7c28ce107608bfe71f808ba5bf58379437b2963b6894 MRO-3.2.5-Ubuntu-14.4.x86_64.deb" | sha256sum -c - && \
    dpkg -i MRO-3.2.5-Ubuntu-14.4.x86_64.deb && \
    rm MRO-3.2.5-Ubuntu-14.4.x86_64.deb

# Neovim

RUN apt-get install software-properties-common
RUN add-apt-repository ppa:neovim-ppa/unstable && \
	apt-get update && apt-get install -yq neovim && \
	apt-get install -yq python-dev python-pip python3-dev python3-pip && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*


RUN echo "en_US.UTF-8 UTF-8" > /etc/locale.gen && \
    locale-gen

# Configure environment
ENV SHELL /bin/zsh
ENV NB_USER diogro
ENV NB_UID 1000
ENV HOME /home/diogro
ENV LC_ALL en_US.UTF-8
ENV LANG en_US.UTF-8
ENV LANGUAGE en_US.UTF-8

# Create diogro user with UID=1000 and in the 'users' group
RUN useradd -m -s /bin/bash -N -u $NB_UID $NB_USER 

USER diogro

# Setup diogro home directory
RUN mkdir /home/$NB_USER/projects
WORKDIR /home/$NB_USER
RUN curl https://j.mp/spf13-vim3 -L > spf13-vim.sh && sh spf13-vim.sh
RUN sh -c "$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"
WORKDIR /home/$NB_USER/.spf13-vim-3
RUN git remote add personal https://github.com/diogro/spf13-vim.git
RUN git pull personal local:local && git checkout local && vim +BundleInstall +BundleClean +q +q
WORKDIR /home/$NB_USER/
RUN mkdir .config/ && mkdir .config/nvim
WORKDIR /home/$NB_USER/.spf13-vim-3
RUN make

USER root

# Configure container startup as root
EXPOSE 8888
WORKDIR /home/$NB_USER/
ENTRYPOINT ["tini", "--"]

# Switch back to diogro to avoid accidental container runs as root
USER diogro
